<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CSAPP-Bomblab详解（含secret_phase） | 徒心的网络自留地</title><meta name="author" content="徒心"><meta name="copyright" content="徒心"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Data Lab [Updated 1&#x2F;12&#x2F;16] (README, Writeup, Release Notes, Self-Study Handout)  A “binary bomb” is a program provided to students as an object code file. When run, it prompts the user to type in 6 di">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP-Bomblab详解（含secret_phase）">
<meta property="og:url" content="https://jkup64.github.io/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/index.html">
<meta property="og:site_name" content="徒心的网络自留地">
<meta property="og:description" content="Data Lab [Updated 1&#x2F;12&#x2F;16] (README, Writeup, Release Notes, Self-Study Handout)  A “binary bomb” is a program provided to students as an object code file. When run, it prompts the user to type in 6 di">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jkup64.github.io/images/csapp.png">
<meta property="article:published_time" content="2023-05-27T08:35:04.000Z">
<meta property="article:modified_time" content="2023-06-21T07:27:31.568Z">
<meta property="article:author" content="徒心">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jkup64.github.io/images/csapp.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://jkup64.github.io/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="6KEGOdCLLrPC5PX81XZwi31w2fujLtnRiMAZZjiFYow"/><meta name="baidu-site-verification" content="code-fuHCOXmgL5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离文章上次更新已过去","messageNext":"天, 内容可能已过期."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CSAPP-Bomblab详解（含secret_phase）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-21 15:27:31'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avater2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/csapp.png')"><nav id="nav"><span id="blog-info"><a href="/" title="徒心的网络自留地"><span class="site-name">徒心的网络自留地</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CSAPP-Bomblab详解（含secret_phase）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-27T08:35:04.000Z" title="发表于 2023-05-27 16:35:04">2023-05-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-21T07:27:31.568Z" title="更新于 2023-06-21 15:27:31">2023-06-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/CSAPP/">CSAPP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CSAPP-Bomblab详解（含secret_phase）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/im/labs/datalab.tar"><em>Data Lab</em></a> <em>[Updated 1/12/16]</em> (<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/README-bomblab">README</a>, <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/bomblab.pdf">Writeup</a>, <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/bomblab-release.html">Release Notes</a>, <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/bomb.tar">Self-Study Handout</a>)</p>
<blockquote>
<p>A “binary bomb” is a program provided to students as an object code file. When run, it prompts the user to type in 6 different strings. If any of these is incorrect, the bomb “explodes,” printing an error message and logging the event on a grading server. Students must “defuse” their own unique bomb by disassembling and reverse engineering the program to determine what the 6 strings should be. The lab teaches students to understand assembly language, and also forces them to learn how to use a debugger. It’s also great fun. A legendary lab among the CMU undergrads.</p>
<p>Here’s a <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/bomb.tar">Linux/x86-64 binary bomb</a> that you can try out for yourself. The feature that notifies the grading server has been disabled, so feel free to explode this bomb with impunity. If you’re an instructor with a CS:APP account, then you can download the <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/im/bomb-solution.txt">solution</a>.</p>
</blockquote>
<p>实验作业网址：<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">http://csapp.cs.cmu.edu/3e/labs.html</a></p>
<hr>
<p>网上许多教程都是基于naive gdb来做的，但Beej’s <a target="_blank" rel="noopener" href="http://beej.us/guide/bggdb/">Quick Guide to GDB</a>中作者都说从来不会直接使用普通模式的gdb。<br>
本文基于IDA pro和pwndbg：</p>
<ul>
<li>IDA：强大的反汇编（反编译）工具，指令流图和F5反编译用起来太爽啦。</li>
<li>pwndbg：gdb的插件，可以在调试时显示寄存器、指令列表、栈、backstrace等信息和辅助提示信息。</li>
</ul>
<p>注意：</p>
<ul>
<li>pwndbg与naive gdb使用上有些不同，比如不能使用<code>disas</code> ，得用<code>disassemble</code> ，输出的格式也不是gdb默认的AT&amp;T格式，而是intel格式，这与IDA反汇编格式相同，看起来更方便。</li>
<li>使用naive gdb对熟练gdb很有好处，但作为使用十个手指的人类，我还是更喜欢看IDA强大的反编译工具，和pwndbg辅助插件。</li>
</ul>
<h1 id="phase-1">phase_1</h1>
<aside>
💡 x86_64 linux 通过 rdi, rsi 分别传入函数参数
</aside>
<p><code>pwndbg&gt;disassemble main</code> 可以看到main()函数<strong>反汇编</strong>结果，可以观察到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000400e32 &lt;+146&gt;:   call   0x40149e &lt;read_line&gt;</span><br><span class="line">0x0000000000400e37 &lt;+151&gt;:   mov    rdi,rax</span><br><span class="line">0x0000000000400e3a &lt;+154&gt;:   call   0x400ee0 &lt;phase_1&gt;</span><br><span class="line">0x0000000000400e3f &lt;+159&gt;:   call   0x4015c4 &lt;phase_defused&gt;</span><br></pre></td></tr></table></figure>
<p>read_line的返回值rax是读入的字符串地址，传给了rdi，应当是要作为phase_1的参数，里面存放的是我们的输入值。查看phase_1的反汇编代码，可知正确答案放在0x401338的位置，赋给esi后作为<code>strings_not_equal</code>函数的参数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">──────────────────────────────────────────────────────────────────────────────[ DISASM / x86<span class="number">-64</span> / set emulate on ]───────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x400ee0</span> &lt;phase_1&gt;       sub    rsp, <span class="number">8</span></span><br><span class="line">   <span class="number">0x400ee4</span> &lt;phase_1+<span class="number">4</span>&gt;     mov    esi, <span class="number">0x402400</span></span><br><span class="line"> ► <span class="number">0x400ee9</span> &lt;phase_1+<span class="number">9</span>&gt;     call   strings_not_equal                      &lt;strings_not_equal&gt;</span><br><span class="line">        rdi: <span class="number">0x603780</span> (input_strings) ◂— <span class="number">0x363636616b6a</span> <span class="comment">/* &#x27;jka666&#x27; */</span></span><br><span class="line">        rsi: <span class="number">0x402400</span> ◂— outsd dx, dword ptr [rsi] <span class="comment">/* &#x27;Border relations with Canada have never been better.&#x27; */</span></span><br><span class="line">        rdx: <span class="number">0x1</span></span><br><span class="line">        rcx: <span class="number">0x6</span></span><br></pre></td></tr></table></figure>
<p>IDA pro反编译结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_1</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">strings_not_equal</span>(a1, <span class="string">&quot;Border relations with Canada have never been better.&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)result )</span><br><span class="line">    <span class="built_in">explode_bomb</span>(a1, <span class="string">&quot;Border relations with Canada have never been better.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="phase-2">phase_2</h1>
<p>使用IDA pro 对<code>phase_2()</code>和<code>read_six_numbers()</code>的<strong>反编译</strong>结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_2</span><span class="params">(__int64 a1)</span>  <span class="comment">// a1 = RDI = RAX 是readline的返回字符串地址</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-38h] BYREF  // 特意将6字节数组表示为3个变量</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+4h] [rbp-34h] BYREF  // 方便循环特殊情况表示</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+18h] [rbp-20h] BYREF //</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read_six_numbers</span>(a1, &amp;v3);  <span class="comment">// read_six_number会将读入结果放到rsp往后18h=24个字节</span></span><br><span class="line">  <span class="keyword">if</span> ( v3 != <span class="number">1</span> )  <span class="comment">// 首元素需为1</span></span><br><span class="line">    <span class="built_in">explode_bomb</span>(a1, &amp;v3);</span><br><span class="line">  v2 = &amp;v4;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">2</span> * *((_DWORD *)v2 - <span class="number">1</span>));  <span class="comment">// result = 2*arr[i-1]</span></span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)v2 != (_DWORD)result )</span><br><span class="line">      <span class="built_in">explode_bomb</span>(a1, &amp;v3);</span><br><span class="line">    v2 += <span class="number">4</span>;  <span class="comment">// 转成_DWORD*加1, 或char*加4</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v2 != &amp;v5 );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">read_six_numbers</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = __isoc99_sscanf(a1, <span class="string">&quot;%d %d %d %d %d %d&quot;</span>, a2, a2 + <span class="number">4</span>, a2 + <span class="number">8</span>, a2 + <span class="number">12</span>, a2 + <span class="number">16</span>, a2 + <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)result &lt;= <span class="number">5</span> )</span><br><span class="line">    <span class="built_in">explode_bomb</span>(a1, <span class="string">&quot;%d %d %d %d %d %d&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序会使用sscanf() 从rax地址的字符串中读取6个整数到rsp往后的26=18h个字节处，读入第一个数字需要为1，后面每个数字需要是前一个数字的2倍。</p>
<aside>
💡 笔记：sscanf()和scanf()都是读取到局部缓冲区的，这样大块的局部内存是在栈上，是从低位往高位放的（与栈增长的方向相反）。
</aside>
<h1 id="phase-3">phase_3</h1>
<p>反编译 <code>phase_3()</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_3</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rcx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+Ch] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)__isoc99_sscanf(a1, <span class="string">&quot;%d %d&quot;</span>, &amp;v4, &amp;v5) &lt;= <span class="number">1</span> )</span><br><span class="line">    <span class="built_in">explode_bomb</span>(a1, <span class="string">&quot;%d %d&quot;</span>, v1, v2);</span><br><span class="line">  <span class="keyword">switch</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      result = <span class="number">207LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      result = <span class="number">311LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      result = <span class="number">707LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      result = <span class="number">256LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      result = <span class="number">389LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      result = <span class="number">206LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      result = <span class="number">682LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">      result = <span class="number">327LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">explode_bomb</span>(a1, <span class="string">&quot;%d %d&quot;</span>, v1, v2);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)result != v5 )</span><br><span class="line">    <span class="built_in">explode_bomb</span>(a1, <span class="string">&quot;%d %d&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<aside>
💡 笔记：
JA (above) 和 JB (below) 针对无符号数，JG (greater) 和 JL (lower) 针对有符号数
cmp 是-=，test是&
switch语句是通过跳转表结果实现的，效率高
</aside>
<h1 id="phase-4">phase_4</h1>
<p><code>phase_4()</code> 和 <code>func4()</code> 的反编译结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_4</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-10h] BYREF  // IDA是根据jbe判断为无符号数的</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_sscanf(a1, <span class="string">&quot;%d %d&quot;</span>, &amp;v2, &amp;v3) != <span class="number">2</span> || v2 &gt; <span class="number">0xE</span> )</span><br><span class="line">    <span class="built_in">explode_bomb</span>();</span><br><span class="line">  result = <span class="built_in">func4</span>(v2, <span class="number">0LL</span>, <span class="number">14LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)result || v3 )</span><br><span class="line">    <span class="built_in">explode_bomb</span>();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">func4</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = ((<span class="type">int</span>)a3 - (<span class="type">int</span>)a2) / <span class="number">2</span> + a2;  <span class="comment">// v3 = (a2+a3)/2 = 7L</span></span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt; (<span class="type">int</span>)a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">func4</span>(a1, a2, (<span class="type">unsigned</span> <span class="type">int</span>)(v3 - <span class="number">1</span>));</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; (<span class="type">int</span>)a1 )</span><br><span class="line">    result = <span class="number">2</span> * (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">func4</span>(a1, (<span class="type">unsigned</span> <span class="type">int</span>)(v3 + <span class="number">1</span>), a3) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>观察 <code>phase_4()</code> ，输入的第一个数字v2不能大于14，第二个数字v3必须为0，且<code>func4()</code>必须返回0。</p>
<p>观察 <code>func4()</code>，其实就可以获得一组解：<code>7 0</code> ，结果进行再整理一下可以看出是个二分算法（但具体是干啥的猜不出，欢迎大神在评论区解答）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">func4</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> i, <span class="type">int</span> j)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (val == n) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> val = (j + i) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (val &lt;= n) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * <span class="built_in">func4</span>(n, val+<span class="number">1</span>, j) + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * <span class="built_in">func4</span>(n, i, val<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>phase_4共有4组解：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span></span><br><span class="line"><span class="number">3</span> <span class="number">0</span></span><br><span class="line"><span class="number">7</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<aside>
💡 笔记: shl/shr分别是逻辑左/右移，sal/sar是算术移动
</aside>
<h1 id="phase-5">phase_5</h1>
<p>反编译代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">phase_5</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">string_length</span>() != <span class="number">6</span> )</span><br><span class="line">    <span class="built_in">explode_bomb</span>(a1, a2);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">6</span>; ++i )</span><br><span class="line">    v4[i] = array_3449[*(_BYTE *)(a1 + i) &amp; <span class="number">0xF</span>];</span><br><span class="line">  v4[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">strings_not_equal</span>(v4, <span class="string">&quot;flyers&quot;</span>) )</span><br><span class="line">    <span class="built_in">explode_bomb</span>(v4, <span class="string">&quot;flyers&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上还要参考反汇编代码和调试运行时信息才能把这题做好：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disassemble phase_5</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function phase_5:</span><br><span class="line">   <span class="number">0x0000000000401062</span> &lt;+<span class="number">0</span>&gt;:     push   rbx</span><br><span class="line">   <span class="number">0x0000000000401063</span> &lt;+<span class="number">1</span>&gt;:     sub    rsp,<span class="number">0x20</span></span><br><span class="line">   <span class="number">0x0000000000401067</span> &lt;+<span class="number">5</span>&gt;:     mov    rbx,rdi  ; rbx放输入字符串</span><br><span class="line">=&gt; <span class="number">0x000000000040106a</span> &lt;+<span class="number">8</span>&gt;:     mov    rax,QWORD PTR fs:<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x0000000000401073</span> &lt;+<span class="number">17</span>&gt;:    mov    QWORD PTR [rsp+<span class="number">0x18</span>],rax  ; 防护，设置一个canary，可以不管它</span><br><span class="line">   <span class="number">0x0000000000401078</span> &lt;+<span class="number">22</span>&gt;:    <span class="keyword">xor</span>    eax,eax</span><br><span class="line">   <span class="number">0x000000000040107a</span> &lt;+<span class="number">24</span>&gt;:    call   <span class="number">0x40131b</span> &lt;string_length&gt;</span><br><span class="line">   <span class="number">0x000000000040107f</span> &lt;+<span class="number">29</span>&gt;:    cmp    eax,<span class="number">0x6</span></span><br><span class="line">   <span class="number">0x0000000000401082</span> &lt;+<span class="number">32</span>&gt;:    je     <span class="number">0x4010d2</span> &lt;phase_5+<span class="number">112</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401084</span> &lt;+<span class="number">34</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x0000000000401089</span> &lt;+<span class="number">39</span>&gt;:    jmp    <span class="number">0x4010d2</span> &lt;phase_5+<span class="number">112</span>&gt;</span><br><span class="line">---------------------------- <span class="keyword">for</span> （参考IDA反编译代码）</span><br><span class="line">   <span class="number">0x000000000040108b</span> &lt;+<span class="number">41</span>&gt;:    movzx  ecx,BYTE PTR [rbx+rax*<span class="number">1</span>]  ; 逐字符访问输入</span><br><span class="line">   <span class="number">0x000000000040108f</span> &lt;+<span class="number">45</span>&gt;:    mov    BYTE PTR [rsp],cl</span><br><span class="line">   <span class="number">0x0000000000401092</span> &lt;+<span class="number">48</span>&gt;:    mov    rdx,QWORD PTR [rsp]</span><br><span class="line">   <span class="number">0x0000000000401096</span> &lt;+<span class="number">52</span>&gt;:    <span class="keyword">and</span>    edx,<span class="number">0xf</span>  ; 取字符低<span class="number">4</span>位</span><br><span class="line">   <span class="number">0x0000000000401099</span> &lt;+<span class="number">55</span>&gt;:    movzx  edx,BYTE PTR [rdx+<span class="number">0x4024b0</span>]  </span><br><span class="line">   <span class="number">0x00000000004010a0</span> &lt;+<span class="number">62</span>&gt;:    mov    BYTE PTR [rsp+rax*<span class="number">1</span>+<span class="number">0x10</span>],dl</span><br><span class="line">   <span class="number">0x00000000004010a4</span> &lt;+<span class="number">66</span>&gt;:    add    rax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00000000004010a8</span> &lt;+<span class="number">70</span>&gt;:    cmp    rax,<span class="number">0x6</span></span><br><span class="line">   <span class="number">0x00000000004010ac</span> &lt;+<span class="number">74</span>&gt;:    jne    <span class="number">0x40108b</span> &lt;phase_5+<span class="number">41</span>&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x00000000004010ae</span> &lt;+<span class="number">76</span>&gt;:    mov    BYTE PTR [rsp+<span class="number">0x16</span>],<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x00000000004010b3</span> &lt;+<span class="number">81</span>&gt;:    mov    esi,<span class="number">0x40245e</span>  ; <span class="string">&quot;flyers&quot;</span></span><br><span class="line">   <span class="number">0x00000000004010b8</span> &lt;+<span class="number">86</span>&gt;:    lea    rdi,[rsp+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x00000000004010bd</span> &lt;+<span class="number">91</span>&gt;:    call   <span class="number">0x401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">   <span class="number">0x00000000004010c2</span> &lt;+<span class="number">96</span>&gt;:    test   eax,eax</span><br><span class="line">   <span class="number">0x00000000004010c4</span> &lt;+<span class="number">98</span>&gt;:    je     <span class="number">0x4010d9</span> &lt;phase_5+<span class="number">119</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004010c6</span> &lt;+<span class="number">100</span>&gt;:   call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x00000000004010cb</span> &lt;+<span class="number">105</span>&gt;:   nop    DWORD PTR [rax+rax*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">   <span class="number">0x00000000004010d0</span> &lt;+<span class="number">110</span>&gt;:   jmp    <span class="number">0x4010d9</span> &lt;phase_5+<span class="number">119</span>&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x00000000004010d2</span> &lt;+<span class="number">112</span>&gt;:   mov    eax,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x00000000004010d7</span> &lt;+<span class="number">117</span>&gt;:   jmp    <span class="number">0x40108b</span> &lt;phase_5+<span class="number">41</span>&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x00000000004010d9</span> &lt;+<span class="number">119</span>&gt;:   mov    rax,QWORD PTR [rsp+<span class="number">0x18</span>]</span><br><span class="line">   <span class="number">0x00000000004010de</span> &lt;+<span class="number">124</span>&gt;:   <span class="keyword">xor</span>    rax,QWORD PTR fs:<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x00000000004010e7</span> &lt;+<span class="number">133</span>&gt;:   je     <span class="number">0x4010ee</span> &lt;phase_5+<span class="number">140</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004010e9</span> &lt;+<span class="number">135</span>&gt;:   call   <span class="number">0x400b30</span> &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   <span class="number">0x00000000004010ee</span> &lt;+<span class="number">140</span>&gt;:   add    rsp,<span class="number">0x20</span></span><br><span class="line">   <span class="number">0x00000000004010f2</span> &lt;+<span class="number">144</span>&gt;:   pop    rbx</span><br><span class="line">   <span class="number">0x00000000004010f3</span> &lt;+<span class="number">145</span>&gt;:   ret</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/s <span class="number">0x4024b0</span></span><br><span class="line"><span class="number">0x4024b0</span> &lt;array<span class="number">.3449</span>&gt;:  <span class="string">&quot;maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?&quot;</span></span><br><span class="line"></span><br><span class="line">或在IDA中去看这段数据：</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>0 array_3449      db <span class="number">6</span>Dh                  ; DATA XREF: phase_5+<span class="number">37</span>↑r</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>1                 db  <span class="number">61</span>h ; a</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>2                 db  <span class="number">64</span>h ; d</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>3                 db  <span class="number">75</span>h ; u</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>4                 db  <span class="number">69</span>h ; i</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>5                 db  <span class="number">65</span>h ; e</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>6                 db  <span class="number">72</span>h ; r</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>7                 db  <span class="number">73</span>h ; s</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>8                 db  <span class="number">6</span>Eh ; n</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>9                 db  <span class="number">66</span>h ; f</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>A                 db  <span class="number">6F</span>h ; o</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>B                 db  <span class="number">74</span>h ; t</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>C                 db  <span class="number">76</span>h ; v</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>D                 db  <span class="number">62</span>h ; b</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>E                 db  <span class="number">79</span>h ; y</span><br><span class="line">.rodata:<span class="number">00000000004024B</span>F                 db  <span class="number">6</span>Ch ; l</span><br><span class="line">.rodata:<span class="number">00000000004024</span>C0 ; <span class="type">const</span> <span class="type">char</span> aSoYouThinkYouC[]</span><br><span class="line">.rodata:<span class="number">00000000004024</span>C0 aSoYouThinkYouC db <span class="string">&#x27;So you think you can stop the bomb with ctrl-c, do you?&#x27;</span>,<span class="number">0</span></span><br><span class="line">.rodata:<span class="number">00000000004024</span>C0                                         ; DATA XREF: sig_handler+<span class="number">4</span>↑o</span><br><span class="line">.rodata:<span class="number">00000000004024F</span>8 ; <span class="type">const</span> <span class="type">char</span> aCursesYouVeFou[]</span><br><span class="line">.rodata:<span class="number">00000000004024F</span>8 aCursesYouVeFou db <span class="string">&#x27;Curses, you&#x27;</span>,<span class="number">27</span>h,<span class="string">&#x27;ve found the secret phase!&#x27;</span>,<span class="number">0</span></span><br><span class="line">.rodata:<span class="number">00000000004024F</span>8                                         ; DATA XREF: phase_defused+<span class="number">53</span>↑o</span><br></pre></td></tr></table></figure>
<p>看反汇编代码时可参考IDA生成的指令流图：</p>
<p><img src="/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/Untitled.png" alt="Untitled"></p>
<p>程序意图为：读取一个长度为6的字符串，对于每个字符截取后四位数字，用来作为index获取另一个字符串里对应的字符，并保存起来，产生一个新的长度为6的字符串，要求等于另一个字符串。</p>
<p>根据IDA中.rodata中0x4024b0处数据可以直观看到：”flyers”各字符在0x4024b0字符串中分别由索引<code>9FE567</code> 获得，输入的字符串后4位需分别为这些数。参考ASCII表：</p>
<p><img src="/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/Untitled%201.png" alt="Untitled"></p>
<p>可构造出输入：<code>9?&gt;567</code></p>
<hr>
<p>前排提示：phase_6 和 secret_phase 难度稍大，想速通的玩家可以先跳过。</p>
<h1 id="phase-6">phase_6</h1>
<p>对于涉及复杂数据结构的程序，IDA的反编译结果可读性不佳（反编译代码甚至比反汇编还长），这里不妨先看看反汇编的结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disassemble phase_6</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function phase_6:</span><br><span class="line">   <span class="number">0x00000000004010f4</span> &lt;+<span class="number">0</span>&gt;:     push   r14</span><br><span class="line">   <span class="number">0x00000000004010f6</span> &lt;+<span class="number">2</span>&gt;:     push   r13</span><br><span class="line">   <span class="number">0x00000000004010f8</span> &lt;+<span class="number">4</span>&gt;:     push   r12</span><br><span class="line">   <span class="number">0x00000000004010fa</span> &lt;+<span class="number">6</span>&gt;:     push   rbp</span><br><span class="line">   <span class="number">0x00000000004010fb</span> &lt;+<span class="number">7</span>&gt;:     push   rbx</span><br><span class="line">   <span class="number">0x00000000004010fc</span> &lt;+<span class="number">8</span>&gt;:     sub    rsp,<span class="number">0x50</span></span><br><span class="line">   <span class="number">0x0000000000401100</span> &lt;+<span class="number">12</span>&gt;:    mov    r13,rsp</span><br><span class="line">   <span class="number">0x0000000000401103</span> &lt;+<span class="number">15</span>&gt;:    mov    rsi,rsp</span><br><span class="line">   <span class="number">0x0000000000401106</span> &lt;+<span class="number">18</span>&gt;:    call   <span class="number">0x40145c</span> &lt;read_six_numbers&gt;  <span class="comment">// 6个输入数字读在rsp位置</span></span><br><span class="line">---------------------------- 外层 <span class="keyword">for</span></span><br><span class="line">   <span class="number">0x000000000040110b</span> &lt;+<span class="number">23</span>&gt;:    mov    r14,rsp</span><br><span class="line">   <span class="number">0x000000000040110e</span> &lt;+<span class="number">26</span>&gt;:    mov    r12d,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x0000000000401114</span> &lt;+<span class="number">32</span>&gt;:    mov    rbp,r13</span><br><span class="line">   <span class="number">0x0000000000401117</span> &lt;+<span class="number">35</span>&gt;:    mov    eax,DWORD PTR [r13+<span class="number">0x0</span>] ; rbp,r14,r13都等于rsp, rsi在进入read函数后被改</span><br><span class="line">   <span class="number">0x000000000040111b</span> &lt;+<span class="number">39</span>&gt;:    sub    eax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040111e</span> &lt;+<span class="number">42</span>&gt;:    cmp    eax,<span class="number">0x5</span></span><br><span class="line">   <span class="number">0x0000000000401121</span> &lt;+<span class="number">45</span>&gt;:    jbe    <span class="number">0x401128</span> &lt;phase_6+<span class="number">52</span>&gt; ; <span class="number">6</span>个元素都: <span class="number">-1</span>后小于等于<span class="number">5</span></span><br><span class="line">   <span class="number">0x0000000000401123</span> &lt;+<span class="number">47</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x0000000000401128</span> &lt;+<span class="number">52</span>&gt;:    add    r12d,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040112c</span> &lt;+<span class="number">56</span>&gt;:    cmp    r12d,<span class="number">0x6</span></span><br><span class="line">   <span class="number">0x0000000000401130</span> &lt;+<span class="number">60</span>&gt;:    je     <span class="number">0x401153</span> &lt;phase_6+<span class="number">95</span>&gt;</span><br><span class="line">---------------------------- 内层 <span class="keyword">for</span></span><br><span class="line">   <span class="number">0x0000000000401132</span> &lt;+<span class="number">62</span>&gt;:    mov    ebx,r12d</span><br><span class="line">   <span class="number">0x0000000000401135</span> &lt;+<span class="number">65</span>&gt;:    movsxd rax,ebx</span><br><span class="line">   <span class="number">0x0000000000401138</span> &lt;+<span class="number">68</span>&gt;:    mov    eax,DWORD PTR [rsp+rax*<span class="number">4</span>]</span><br><span class="line">   <span class="number">0x000000000040113b</span> &lt;+<span class="number">71</span>&gt;:    cmp    DWORD PTR [rbp+<span class="number">0x0</span>],eax</span><br><span class="line">   <span class="number">0x000000000040113e</span> &lt;+<span class="number">74</span>&gt;:    jne    <span class="number">0x401145</span> &lt;phase_6+<span class="number">81</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401140</span> &lt;+<span class="number">76</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x0000000000401145</span> &lt;+<span class="number">81</span>&gt;:    add    ebx,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x0000000000401148</span> &lt;+<span class="number">84</span>&gt;:    cmp    ebx,<span class="number">0x5</span></span><br><span class="line">   <span class="number">0x000000000040114b</span> &lt;+<span class="number">87</span>&gt;:    jle    <span class="number">0x401135</span> &lt;phase_6+<span class="number">65</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040114d</span> &lt;+<span class="number">89</span>&gt;:    add    r13,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x0000000000401151</span> &lt;+<span class="number">93</span>&gt;:    jmp    <span class="number">0x401114</span> &lt;phase_6+<span class="number">32</span>&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x0000000000401153</span> &lt;+<span class="number">95</span>&gt;:    lea    rsi,[rsp+<span class="number">0x18</span>]  ; 输入的结尾\<span class="number">0</span></span><br><span class="line">   <span class="number">0x0000000000401158</span> &lt;+<span class="number">100</span>&gt;:   mov    rax,r14</span><br><span class="line">   <span class="number">0x000000000040115b</span> &lt;+<span class="number">103</span>&gt;:   mov    ecx,<span class="number">0x7</span></span><br><span class="line">   <span class="number">0x0000000000401160</span> &lt;+<span class="number">108</span>&gt;:   mov    edx,ecx</span><br><span class="line">   <span class="number">0x0000000000401162</span> &lt;+<span class="number">110</span>&gt;:   sub    edx,DWORD PTR [rax]</span><br><span class="line">   <span class="number">0x0000000000401164</span> &lt;+<span class="number">112</span>&gt;:   mov    DWORD PTR [rax],edx</span><br><span class="line">   <span class="number">0x0000000000401166</span> &lt;+<span class="number">114</span>&gt;:   add    rax,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x000000000040116a</span> &lt;+<span class="number">118</span>&gt;:   cmp    rax,rsi</span><br><span class="line">   <span class="number">0x000000000040116d</span> &lt;+<span class="number">121</span>&gt;:   jne    <span class="number">0x401160</span> &lt;phase_6+<span class="number">108</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040116f</span> &lt;+<span class="number">123</span>&gt;:   mov    esi,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x0000000000401174</span> &lt;+<span class="number">128</span>&gt;:   jmp    <span class="number">0x401197</span> &lt;phase_6+<span class="number">163</span>&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x0000000000401176</span> &lt;+<span class="number">130</span>&gt;:   mov    rdx,QWORD PTR [rdx+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x000000000040117a</span> &lt;+<span class="number">134</span>&gt;:   add    eax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040117d</span> &lt;+<span class="number">137</span>&gt;:   cmp    eax,ecx</span><br><span class="line">   <span class="number">0x000000000040117f</span> &lt;+<span class="number">139</span>&gt;:   jne    <span class="number">0x401176</span> &lt;phase_6+<span class="number">130</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401181</span> &lt;+<span class="number">141</span>&gt;:   jmp    <span class="number">0x401188</span> &lt;phase_6+<span class="number">148</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401183</span> &lt;+<span class="number">143</span>&gt;:   mov    edx,<span class="number">0x6032d0</span></span><br><span class="line">   <span class="number">0x0000000000401188</span> &lt;+<span class="number">148</span>&gt;:   mov    QWORD PTR [rsp+rsi*<span class="number">2</span>+<span class="number">0x20</span>],rdx</span><br><span class="line">   <span class="number">0x000000000040118d</span> &lt;+<span class="number">153</span>&gt;:   add    rsi,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x0000000000401191</span> &lt;+<span class="number">157</span>&gt;:   cmp    rsi,<span class="number">0x18</span></span><br><span class="line">   <span class="number">0x0000000000401195</span> &lt;+<span class="number">161</span>&gt;:   je     <span class="number">0x4011ab</span> &lt;phase_6+<span class="number">183</span>&gt;</span><br><span class="line">----------------------------</span><br><span class="line">   <span class="number">0x0000000000401197</span> &lt;+<span class="number">163</span>&gt;:   mov    ecx,DWORD PTR [rsp+rsi*<span class="number">1</span>]</span><br><span class="line">   <span class="number">0x000000000040119a</span> &lt;+<span class="number">166</span>&gt;:   cmp    ecx,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040119d</span> &lt;+<span class="number">169</span>&gt;:   jle    <span class="number">0x401183</span> &lt;phase_6+<span class="number">143</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040119f</span> &lt;+<span class="number">171</span>&gt;:   mov    eax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00000000004011a4</span> &lt;+<span class="number">176</span>&gt;:   mov    edx,<span class="number">0x6032d0</span></span><br><span class="line">   <span class="number">0x00000000004011a9</span> &lt;+<span class="number">181</span>&gt;:   jmp    <span class="number">0x401176</span> &lt;phase_6+<span class="number">130</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x00000000004011ab</span> &lt;+<span class="number">183</span>&gt;:   mov    rbx,QWORD PTR [rsp+<span class="number">0x20</span>]</span><br><span class="line">   <span class="number">0x00000000004011b0</span> &lt;+<span class="number">188</span>&gt;:   lea    rax,[rsp+<span class="number">0x28</span>]</span><br><span class="line">   <span class="number">0x00000000004011b5</span> &lt;+<span class="number">193</span>&gt;:   lea    rsi,[rsp+<span class="number">0x50</span>]</span><br><span class="line">   <span class="number">0x00000000004011ba</span> &lt;+<span class="number">198</span>&gt;:   mov    rcx,rbx</span><br><span class="line">   <span class="number">0x00000000004011bd</span> &lt;+<span class="number">201</span>&gt;:   mov    rdx,QWORD PTR [rax]</span><br><span class="line">   <span class="number">0x00000000004011c0</span> &lt;+<span class="number">204</span>&gt;:   mov    QWORD PTR [rcx+<span class="number">0x8</span>],rdx</span><br><span class="line">   <span class="number">0x00000000004011c4</span> &lt;+<span class="number">208</span>&gt;:   add    rax,<span class="number">0x8</span></span><br><span class="line">   <span class="number">0x00000000004011c8</span> &lt;+<span class="number">212</span>&gt;:   cmp    rax,rsi</span><br><span class="line">   <span class="number">0x00000000004011cb</span> &lt;+<span class="number">215</span>&gt;:   je     <span class="number">0x4011d2</span> &lt;phase_6+<span class="number">222</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004011cd</span> &lt;+<span class="number">217</span>&gt;:   mov    rcx,rdx</span><br><span class="line">   <span class="number">0x00000000004011d0</span> &lt;+<span class="number">220</span>&gt;:   jmp    <span class="number">0x4011bd</span> &lt;phase_6+<span class="number">201</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004011d2</span> &lt;+<span class="number">222</span>&gt;:   mov    QWORD PTR [rdx+<span class="number">0x8</span>],<span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">   <span class="number">0x00000000004011da</span> &lt;+<span class="number">230</span>&gt;:   mov    ebp,<span class="number">0x5</span></span><br><span class="line">   <span class="number">0x00000000004011df</span> &lt;+<span class="number">235</span>&gt;:   mov    rax,QWORD PTR [rbx+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x00000000004011e3</span> &lt;+<span class="number">239</span>&gt;:   mov    eax,DWORD PTR [rax]</span><br><span class="line">   <span class="number">0x00000000004011e5</span> &lt;+<span class="number">241</span>&gt;:   cmp    DWORD PTR [rbx],eax</span><br><span class="line">   <span class="number">0x00000000004011e7</span> &lt;+<span class="number">243</span>&gt;:   jge    <span class="number">0x4011ee</span> &lt;phase_6+<span class="number">250</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004011e9</span> &lt;+<span class="number">245</span>&gt;:   call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x00000000004011ee</span> &lt;+<span class="number">250</span>&gt;:   mov    rbx,QWORD PTR [rbx+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x00000000004011f2</span> &lt;+<span class="number">254</span>&gt;:   sub    ebp,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00000000004011f5</span> &lt;+<span class="number">257</span>&gt;:   jne    <span class="number">0x4011df</span> &lt;phase_6+<span class="number">235</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004011f7</span> &lt;+<span class="number">259</span>&gt;:   add    rsp,<span class="number">0x50</span></span><br><span class="line">   <span class="number">0x00000000004011fb</span> &lt;+<span class="number">263</span>&gt;:   pop    rbx</span><br><span class="line">   <span class="number">0x00000000004011fc</span> &lt;+<span class="number">264</span>&gt;:   pop    rbp</span><br><span class="line">   <span class="number">0x00000000004011fd</span> &lt;+<span class="number">265</span>&gt;:   pop    r12</span><br><span class="line">   <span class="number">0x00000000004011ff</span> &lt;+<span class="number">267</span>&gt;:   pop    r13</span><br><span class="line">   <span class="number">0x0000000000401201</span> &lt;+<span class="number">269</span>&gt;:   pop    r14</span><br><span class="line">   <span class="number">0x0000000000401203</span> &lt;+<span class="number">271</span>&gt;:   ret</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<hr>
<p>太复杂了，化整为零，一步步来</p>
<h2 id="Part-6-1-预检测">Part 6.1 预检测</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x00000000004010f4</span> &lt;+<span class="number">0</span>&gt;:     push   r14</span><br><span class="line">   <span class="number">0x00000000004010f6</span> &lt;+<span class="number">2</span>&gt;:     push   r13</span><br><span class="line">   <span class="number">0x00000000004010f8</span> &lt;+<span class="number">4</span>&gt;:     push   r12</span><br><span class="line">   <span class="number">0x00000000004010fa</span> &lt;+<span class="number">6</span>&gt;:     push   rbp</span><br><span class="line">   <span class="number">0x00000000004010fb</span> &lt;+<span class="number">7</span>&gt;:     push   rbx</span><br><span class="line">   <span class="number">0x00000000004010fc</span> &lt;+<span class="number">8</span>&gt;:     sub    rsp,<span class="number">0x50</span></span><br><span class="line">   <span class="number">0x0000000000401100</span> &lt;+<span class="number">12</span>&gt;:    mov    r13,rsp</span><br><span class="line">   <span class="number">0x0000000000401103</span> &lt;+<span class="number">15</span>&gt;:    mov    rsi,rsp</span><br><span class="line">   <span class="number">0x0000000000401106</span> &lt;+<span class="number">18</span>&gt;:    call   <span class="number">0x40145c</span> &lt;read_six_numbers&gt;  ; <span class="number">6</span>个输入数字读在rsp, rsi在进入read函数后被改</span><br><span class="line">---------------------------- 外层<span class="keyword">for</span>, 索引为r12</span><br><span class="line">   <span class="number">0x000000000040110b</span> &lt;+<span class="number">23</span>&gt;:    mov    r14,rsp</span><br><span class="line">   <span class="number">0x000000000040110e</span> &lt;+<span class="number">26</span>&gt;:    mov    r12d,<span class="number">0x0</span>  ; r12初始化为<span class="number">0</span></span><br><span class="line"></span><br><span class="line">   <span class="number">0x0000000000401114</span> &lt;+<span class="number">32</span>&gt;:    mov    rbp,r13</span><br><span class="line">   <span class="number">0x0000000000401117</span> &lt;+<span class="number">35</span>&gt;:    mov    eax,DWORD PTR [r13+<span class="number">0x0</span>]  ; rbp,r14,r13都等于rsp</span><br><span class="line">   <span class="number">0x000000000040111b</span> &lt;+<span class="number">39</span>&gt;:    sub    eax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040111e</span> &lt;+<span class="number">42</span>&gt;:    cmp    eax,<span class="number">0x5</span></span><br><span class="line">   <span class="number">0x0000000000401121</span> &lt;+<span class="number">45</span>&gt;:    jbe    <span class="number">0x401128</span> &lt;phase_6+<span class="number">52</span>&gt;  ; <span class="number">6</span>个元素都: <span class="number">-1</span>后小于等于<span class="number">5</span></span><br><span class="line">   <span class="number">0x0000000000401123</span> &lt;+<span class="number">47</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x0000000000401128</span> &lt;+<span class="number">52</span>&gt;:    add    r12d,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040112c</span> &lt;+<span class="number">56</span>&gt;:    cmp    r12d,<span class="number">0x6</span></span><br><span class="line">   <span class="number">0x0000000000401130</span> &lt;+<span class="number">60</span>&gt;:    je     <span class="number">0x401153</span> &lt;phase_6+<span class="number">95</span>&gt;</span><br><span class="line">---------------------------- 内层<span class="keyword">for</span>, 索引为ebx</span><br><span class="line">   <span class="number">0x0000000000401132</span> &lt;+<span class="number">62</span>&gt;:    mov    ebx,r12d</span><br><span class="line"></span><br><span class="line">   <span class="number">0x0000000000401135</span> &lt;+<span class="number">65</span>&gt;:    movsxd rax,ebx  ; rax = r12 = i</span><br><span class="line">   <span class="number">0x0000000000401138</span> &lt;+<span class="number">68</span>&gt;:    mov    eax,DWORD PTR [rsp+rax*<span class="number">4</span>]</span><br><span class="line">   <span class="number">0x000000000040113b</span> &lt;+<span class="number">71</span>&gt;:    cmp    DWORD PTR [rbp+<span class="number">0x0</span>],eax ; rbp指向rsp, 输入第<span class="number">1</span>个元素</span><br><span class="line">   <span class="number">0x000000000040113e</span> &lt;+<span class="number">74</span>&gt;:    jne    <span class="number">0x401145</span> &lt;phase_6+<span class="number">81</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401140</span> &lt;+<span class="number">76</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x0000000000401145</span> &lt;+<span class="number">81</span>&gt;:    add    ebx,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x0000000000401148</span> &lt;+<span class="number">84</span>&gt;:    cmp    ebx,<span class="number">0x5</span></span><br><span class="line">   <span class="number">0x000000000040114b</span> &lt;+<span class="number">87</span>&gt;:    jle    <span class="number">0x401135</span> &lt;phase_6+<span class="number">65</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040114d</span> &lt;+<span class="number">89</span>&gt;:    add    r13,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x0000000000401151</span> &lt;+<span class="number">93</span>&gt;:    jmp    <span class="number">0x401114</span> &lt;phase_6+<span class="number">32</span>&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_6</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> *v1; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// er12</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// rsi</span></span><br><span class="line">  _QWORD *v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v9; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *v10; <span class="comment">// rax</span></span><br><span class="line">  __int64 j; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// ebp</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v15[<span class="number">6</span>]; <span class="comment">// [rsp+0h] [rbp-78h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [rsp+18h] [rbp-60h] BYREF 18h就是24l，也就是输入字符串结尾\0的位置                  </span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+20h] [rbp-58h]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [rsp+28h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v19[<span class="number">40</span>]; <span class="comment">// [rsp+50h] [rbp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v1 = v15;</span><br><span class="line">  <span class="built_in">read_six_numbers</span>(a1, (__int64)v15);</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(*v1 - <span class="number">1</span>) &gt; <span class="number">5</span> )</span><br><span class="line">      <span class="built_in">explode_bomb</span>(a1, (<span class="type">const</span> <span class="type">char</span> *)v15);</span><br><span class="line">    <span class="keyword">if</span> ( ++v2 == <span class="number">6</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = v2;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v1 == v15[v3] )</span><br><span class="line">        <span class="built_in">explode_bomb</span>(a1, (<span class="type">const</span> <span class="type">char</span> *)v15);</span><br><span class="line">      ++v3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v3 &lt;= <span class="number">5</span> );</span><br><span class="line">    ++v1;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其实就是等价于：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>  (<span class="type">int</span> i=<span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (arr[i] - <span class="number">1</span> &gt; <span class="number">5</span>) <span class="built_in">bomb</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j=i+<span class="number">1</span>; j&lt;=<span class="number">5</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(arr[j] == arr[i]) <span class="built_in">bomb</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 也就是需要输入的6个数字都不大于6，且互异</span></span><br></pre></td></tr></table></figure>
<aside>
💡 笔记：pwndbg中stack区向左指的箭头代表存放的数据是多少；向右指的箭头表示存放的地址是多少（最右边通常会有个向左箭头，代表最终指向的数据）
</aside>
<h2 id="Part-6-2-七减处理">Part 6.2 七减处理</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> ---------------------------- <span class="keyword">for</span>: 使用rax作为循环变量，初始化为r14=rsp</span><br><span class="line"><span class="number">0x0000000000401153</span> &lt;+<span class="number">95</span>&gt;:    lea    rsi,[rsp+<span class="number">0x18</span>]  ; 输入的结尾\<span class="number">0</span></span><br><span class="line"><span class="number">0x0000000000401158</span> &lt;+<span class="number">100</span>&gt;:   mov    rax,r14  ; r14初始时指向rsp, 输入的首地址</span><br><span class="line"><span class="number">0x000000000040115b</span> &lt;+<span class="number">103</span>&gt;:   mov    ecx,<span class="number">0x7</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x0000000000401160</span> &lt;+<span class="number">108</span>&gt;:   mov    edx,ecx</span><br><span class="line"><span class="number">0x0000000000401162</span> &lt;+<span class="number">110</span>&gt;:   sub    edx,DWORD PTR [rax]</span><br><span class="line"><span class="number">0x0000000000401164</span> &lt;+<span class="number">112</span>&gt;:   mov    DWORD PTR [rax],edx</span><br><span class="line"><span class="number">0x0000000000401166</span> &lt;+<span class="number">114</span>&gt;:   add    rax,<span class="number">0x4</span></span><br><span class="line"><span class="number">0x000000000040116a</span> &lt;+<span class="number">118</span>&gt;:   cmp    rax,rsi</span><br><span class="line"><span class="number">0x000000000040116d</span> &lt;+<span class="number">121</span>&gt;:   jne    <span class="number">0x401160</span> &lt;phase_6+<span class="number">108</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">0x000000000040116f</span> &lt;+<span class="number">123</span>&gt;:   mov    esi,<span class="number">0x0</span></span><br><span class="line"><span class="number">0x0000000000401174</span> &lt;+<span class="number">128</span>&gt;:   jmp    <span class="number">0x401197</span> &lt;phase_6+<span class="number">163</span>&gt;</span><br></pre></td></tr></table></figure>
<p>程序目的是，原地修改数组：元素值 = 7 - 元素值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i)</span><br><span class="line">  arr[i] = <span class="number">7</span> - arr[i]</span><br><span class="line"><span class="comment">// 下面将转变后的arr数组称呼为narr</span></span><br></pre></td></tr></table></figure>
<h2 id="Part-6-3-根据输入narr-i-将node-narr-i-的地址复制到stack-nnode-i">Part 6.3 根据输入narr[i]将node[narr[i]]的地址复制到stack[nnode[i]]</h2>
<p>程序入口为&lt;phase_6+163&gt;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---------------------------- 内层 <span class="keyword">for</span> eax: <span class="number">1</span> ~ rcx<span class="number">-1</span>, rcx = narr[i]</span><br><span class="line">   <span class="number">0x0000000000401176</span> &lt;+<span class="number">130</span>&gt;:   mov    rdx,QWORD PTR [rdx+<span class="number">0x8</span>]  ; node[i] = node[i + <span class="number">1</span>], 一次移动<span class="number">4</span>个字(<span class="number">1</span>个node),注意这里只移动rdx,不改变node</span><br><span class="line">   <span class="number">0x000000000040117a</span> &lt;+<span class="number">134</span>&gt;:   add    eax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x000000000040117d</span> &lt;+<span class="number">137</span>&gt;:   cmp    eax,ecx</span><br><span class="line">   <span class="number">0x000000000040117f</span> &lt;+<span class="number">139</span>&gt;:   jne    <span class="number">0x401176</span> &lt;phase_6+<span class="number">130</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401181</span> &lt;+<span class="number">141</span>&gt;:   jmp    <span class="number">0x401188</span> &lt;phase_6+<span class="number">148</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x0000000000401183</span> &lt;+<span class="number">143</span>&gt;:   mov    edx,<span class="number">0x6032d0</span></span><br><span class="line"></span><br><span class="line">   <span class="number">0x0000000000401188</span> &lt;+<span class="number">148</span>&gt;:   mov    QWORD PTR [rsp+rsi*<span class="number">2</span>+<span class="number">0x20</span>],rdx  ; 前面的rsp~rsp+<span class="number">0x20</span>放输入(<span class="number">6B</span>)和结束标志, 这里开始放node, 一次操作<span class="number">8</span>字节(QWORD)</span><br><span class="line">   <span class="number">0x000000000040118d</span> &lt;+<span class="number">153</span>&gt;:   add    rsi,<span class="number">0x4</span>  ; <span class="number">1</span>个node是<span class="number">4B</span>  ; 对narr中的每个数字</span><br><span class="line">   <span class="number">0x0000000000401191</span> &lt;+<span class="number">157</span>&gt;:   cmp    rsi,<span class="number">0x18</span></span><br><span class="line">   <span class="number">0x0000000000401195</span> &lt;+<span class="number">161</span>&gt;:   je     <span class="number">0x4011ab</span> &lt;phase_6+<span class="number">183</span>&gt;</span><br><span class="line"></span><br><span class="line">---------------------------- 外层 <span class="keyword">for</span> rsi &lt;- i, i: <span class="number">0</span> ~ <span class="number">5</span></span><br><span class="line">   <span class="number">0x0000000000401197</span> &lt;+<span class="number">163</span>&gt;:   mov    ecx,DWORD PTR [rsp+rsi*<span class="number">1</span>]  ; rsi在jmp前初始化为<span class="number">0</span>, 在+<span class="number">153</span>-+<span class="number">161</span>进行变动和判断</span><br><span class="line">   <span class="number">0x000000000040119a</span> &lt;+<span class="number">166</span>&gt;:   cmp    ecx,<span class="number">0x1</span>  ; 判断数组中每个数是否小于等于<span class="number">1</span></span><br><span class="line">   <span class="number">0x000000000040119d</span> &lt;+<span class="number">169</span>&gt;:   jle    <span class="number">0x401183</span> &lt;phase_6+<span class="number">143</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040119f</span> &lt;+<span class="number">171</span>&gt;:   mov    eax,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00000000004011a4</span> &lt;+<span class="number">176</span>&gt;:   mov    edx,<span class="number">0x6032d0</span>  ; rdx指向node1</span><br><span class="line">   <span class="number">0x00000000004011a9</span> &lt;+<span class="number">181</span>&gt;:   jmp    <span class="number">0x401176</span> &lt;phase_6+<span class="number">130</span>&gt;</span><br></pre></td></tr></table></figure>
<p>等价代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i)</span><br><span class="line">  stack[nnode[i]] = node[narr[i]]  <span class="comment">// nnode表示栈上放node的地址，其位置与i相关，值由narr[i]确定</span></span><br><span class="line"><span class="comment">// 栈上存放的是node的地址（1qword = 64b），不是完整的node</span></span><br></pre></td></tr></table></figure>
<p>+176处有个奇怪的地址，可以往下按16进制格式查30个word的数据，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>wx <span class="number">0x6032d0</span></span><br><span class="line"><span class="number">0x6032d0</span> &lt;node1&gt;:       <span class="number">0x0000014c</span>      <span class="number">0x00000001</span>      <span class="number">0x006032e0</span>      <span class="number">0x00000000</span>  ; <span class="number">0x006032e0</span>就是下一个node的地址</span><br><span class="line"><span class="number">0x6032e0</span> &lt;node2&gt;:       <span class="number">0x000000a8</span>      <span class="number">0x00000002</span>      <span class="number">0x006032f0</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x6032f0</span> &lt;node3&gt;:       <span class="number">0x0000039c</span>      <span class="number">0x00000003</span>      <span class="number">0x00603300</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x603300</span> &lt;node4&gt;:       <span class="number">0x000002b3</span>      <span class="number">0x00000004</span>      <span class="number">0x00603310</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x603310</span> &lt;node5&gt;:       <span class="number">0x000001dd</span>      <span class="number">0x00000005</span>      <span class="number">0x00603320</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x603320</span> &lt;node6&gt;:       <span class="number">0x000001bb</span>      <span class="number">0x00000006</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x603330</span>:       <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x603340</span> &lt;host_table&gt;:  <span class="number">0x00402629</span>      <span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<p>可以猜测使用到了链表结构，这个链表使用的结构体类似于：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line"> <span class="type">int</span> sth; <span class="comment">// 某四字节内容，关于其用途先按下不表，后面会看到</span></span><br><span class="line"> <span class="type">int</span> input; <span class="comment">// 与我们的输入有关</span></span><br><span class="line"> node* next; <span class="comment">// 下一个node地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<aside>
💡 笔记：Quad word是4个字，1个字是16位，2字节，那么qword其就是64位；1个int对应dword，是2字，4字节。
</aside>
<h2 id="Part-6-4">Part 6.4</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00000000004011ab</span> &lt;+<span class="number">183</span>&gt;:   mov    rbx,QWORD PTR [rsp+<span class="number">0x20</span>] </span><br><span class="line"><span class="number">0x00000000004011b0</span> &lt;+<span class="number">188</span>&gt;:   lea    rax,[rsp+<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x00000000004011b5</span> &lt;+<span class="number">193</span>&gt;:   lea    rsi,[rsp+<span class="number">0x50</span>]  ; 结尾</span><br><span class="line"><span class="number">0x00000000004011ba</span> &lt;+<span class="number">198</span>&gt;:   mov    rcx,rbx</span><br><span class="line"></span><br><span class="line"><span class="number">0x00000000004011bd</span> &lt;+<span class="number">201</span>&gt;:   mov    rdx,QWORD PTR [rax]</span><br><span class="line"><span class="number">0x00000000004011c0</span> &lt;+<span class="number">204</span>&gt;:   mov    QWORD PTR [rcx+<span class="number">0x8</span>],rdx</span><br><span class="line"><span class="number">0x00000000004011c4</span> &lt;+<span class="number">208</span>&gt;:   add    rax,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x00000000004011c8</span> &lt;+<span class="number">212</span>&gt;:   cmp    rax,rsi</span><br><span class="line"><span class="number">0x00000000004011cb</span> &lt;+<span class="number">215</span>&gt;:   je     <span class="number">0x4011d2</span> &lt;phase_6+<span class="number">222</span>&gt;</span><br><span class="line"><span class="number">0x00000000004011cd</span> &lt;+<span class="number">217</span>&gt;:   mov    rcx,rdx</span><br><span class="line"><span class="number">0x00000000004011d0</span> &lt;+<span class="number">220</span>&gt;:   jmp    <span class="number">0x4011bd</span> &lt;phase_6+<span class="number">201</span>&gt;</span><br><span class="line"><span class="number">0x00000000004011d2</span> &lt;+<span class="number">222</span>&gt;:   mov    QWORD PTR [rdx+<span class="number">0x8</span>],<span class="number">0x0</span>  ; 设置链表结尾为null</span><br></pre></td></tr></table></figure>
<p>运行时信息：可以看到确实将node移动到了rsp+20的位置：由于输入为<code>1 2 3 4 5 6</code>，用7减后得<code>6 5 4 3 2 1</code>, 分别对应node6 - node1。若输入改为<code>4 3 2 1 5 6</code>，分别为<code>node 3 4 5 6 2 1</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x4011ab</span> &lt;phase_6+<span class="number">183</span>&gt;    mov    rbx, qword ptr [rsp + <span class="number">0x20</span>]</span><br><span class="line">   <span class="number">0x4011b0</span> &lt;phase_6+<span class="number">188</span>&gt;    lea    rax, [rsp + <span class="number">0x28</span>]</span><br><span class="line">   <span class="number">0x4011b5</span> &lt;phase_6+<span class="number">193</span>&gt;    lea    rsi, [rsp + <span class="number">0x50</span>]</span><br><span class="line">   <span class="number">0x4011ba</span> &lt;phase_6+<span class="number">198</span>&gt;    mov    rcx, rbx</span><br><span class="line">   <span class="number">0x4011bd</span> &lt;phase_6+<span class="number">201</span>&gt;    mov    rdx, qword ptr [rax]</span><br><span class="line">   <span class="number">0x4011c0</span> &lt;phase_6+<span class="number">204</span>&gt;    mov    qword ptr [rcx + <span class="number">8</span>], rdx</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ r14 rsp     <span class="number">0x7fffffffdc00</span> ◂— <span class="number">0x500000006</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7fffffffdc08</span> ◂— <span class="number">0x300000004</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ r13<span class="number">-4</span> rbp<span class="number">-4</span> <span class="number">0x7fffffffdc10</span> ◂— <span class="number">0x100000002</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7fffffffdc18</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7fffffffdc20</span> —▸ <span class="number">0x603320</span> (node6) ◂— <span class="number">0x6000001bb</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x7fffffffdc28</span> —▸ <span class="number">0x603310</span> (node5) ◂— <span class="number">0x5000001dd</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│             <span class="number">0x7fffffffdc30</span> —▸ <span class="number">0x603300</span> (node4) ◂— <span class="number">0x4000002b3</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│             <span class="number">0x7fffffffdc38</span> —▸ <span class="number">0x6032f0</span> (node3) ◂— <span class="number">0x30000039c</span></span><br></pre></td></tr></table></figure>
<p><img src="/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/Untitled%202.png" alt="Untitled"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">6</span>; ++i)</span><br><span class="line">	(*stack[nnode[i]]).next = *stack[nnode[i + <span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line">node[<span class="number">6</span>].next = <span class="literal">nullptr</span></span><br></pre></td></tr></table></figure>
<p>注意搬到栈的数据顺序不一定是654321，这样一个个往后又重新排序好了，我们可以猜测其目的是要进行遍历。</p>
<h2 id="Part-6-5-遍历检查链表中值大小">Part 6.5 遍历检查链表中值大小</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---------------------------- <span class="keyword">for</span> ebp: <span class="number">5</span>~<span class="number">1</span></span><br><span class="line">	 <span class="number">0x00000000004011da</span> &lt;+<span class="number">230</span>&gt;:   mov    ebp,<span class="number">0x5</span></span><br><span class="line"></span><br><span class="line">	 <span class="number">0x00000000004011df</span> &lt;+<span class="number">235</span>&gt;:   mov    rax,QWORD PTR [rbx+<span class="number">0x8</span>]  ; rbx指向头指针</span><br><span class="line">	 <span class="number">0x00000000004011e3</span> &lt;+<span class="number">239</span>&gt;:   mov    eax,DWORD PTR [rax]  ; 移动单字节: 是node的第一个字段</span><br><span class="line">	 <span class="number">0x00000000004011e5</span> &lt;+<span class="number">241</span>&gt;:   cmp    DWORD PTR [rbx],eax  ; 比的也是node.sth</span><br><span class="line">	 <span class="number">0x00000000004011e7</span> &lt;+<span class="number">243</span>&gt;:   jge    <span class="number">0x4011ee</span> &lt;phase_6+<span class="number">250</span>&gt;</span><br><span class="line">	 <span class="number">0x00000000004011e9</span> &lt;+<span class="number">245</span>&gt;:   call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;]</span><br><span class="line"></span><br><span class="line">	 <span class="number">0x00000000004011ee</span> &lt;+<span class="number">250</span>&gt;:   mov    rbx,QWORD PTR [rbx+<span class="number">0x8</span>]  ; 访问next字段</span><br><span class="line">	 <span class="number">0x00000000004011f2</span> &lt;+<span class="number">254</span>&gt;:   sub    ebp,<span class="number">0x1</span></span><br><span class="line">	 <span class="number">0x00000000004011f5</span> &lt;+<span class="number">257</span>&gt;:   jne    <span class="number">0x4011df</span> &lt;phase_6+<span class="number">235</span>&gt;</span><br><span class="line">	 <span class="number">0x00000000004011f7</span> &lt;+<span class="number">259</span>&gt;:   add    rsp,<span class="number">0x50</span></span><br><span class="line">	 <span class="number">0x00000000004011fb</span> &lt;+<span class="number">263</span>&gt;:   pop    rbx</span><br><span class="line">	 <span class="number">0x00000000004011fc</span> &lt;+<span class="number">264</span>&gt;:   pop    rbp</span><br><span class="line">	 <span class="number">0x00000000004011fd</span> &lt;+<span class="number">265</span>&gt;:   pop    r12</span><br><span class="line">	 <span class="number">0x00000000004011ff</span> &lt;+<span class="number">267</span>&gt;:   pop    r13</span><br><span class="line">	 <span class="number">0x0000000000401201</span> &lt;+<span class="number">269</span>&gt;:   pop    r14</span><br><span class="line">	 <span class="number">0x0000000000401203</span> &lt;+<span class="number">271</span>&gt;:   ret</span><br></pre></td></tr></table></figure>
<p>下面果然对链表进行了遍历，看每个元素是否都大于后一个元素，若否则引爆炸弹。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">idx = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">5</span>; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">	<span class="keyword">if</span> (node[idx].sth &gt; node[idx+<span class="number">1</span>].sth)  &#123;</span><br><span class="line">		idx++;</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">bomb</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用x/30wx 0x6032d0查看nodes的sth值大小，确认从大到小的顺序为：<code>node 3 4 5 6 1 2</code>，对应输入为 <code>4 3 2 1 6 5</code>。</p>
<h1 id="secret-phase">secret_phase</h1>
<h2 id="Part-s-1-phase-defused">Part s.1 phase_defused</h2>
<p>在读入6条字符串后检查第4个字符串是否由3部分组成，第3部分是&quot;DrEvil&quot;</p>
<p>反汇编：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">phase_defused</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// [rsp+8h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+Ch] [rbp-6Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">88</span>]; <span class="comment">// [rsp+10h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+68h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( num_input_strings == <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_sscanf(&amp;unk_603870, <span class="string">&quot;%d %d %s&quot;</span>, &amp;v1, &amp;v2, v3) == <span class="number">3</span></span><br><span class="line">      &amp;&amp; !(<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">strings_not_equal</span>(v3, <span class="string">&quot;DrEvil&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Curses, you&#x27;ve found the secret phase!&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;But finding it and solving it are quite different...&quot;</span>);</span><br><span class="line">      <span class="built_in">secret_phase</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Congratulations! You&#x27;ve defused the bomb!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disassemble phase_defused</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function phase_defused:</span><br><span class="line">   <span class="number">0x00000000004015c4</span> &lt;+<span class="number">0</span>&gt;:     sub    rsp,<span class="number">0x78</span></span><br><span class="line">   <span class="number">0x00000000004015c8</span> &lt;+<span class="number">4</span>&gt;:     mov    rax,QWORD PTR fs:<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x00000000004015d1</span> &lt;+<span class="number">13</span>&gt;:    mov    QWORD PTR [rsp+<span class="number">0x68</span>],rax</span><br><span class="line">   <span class="number">0x00000000004015d6</span> &lt;+<span class="number">18</span>&gt;:    <span class="keyword">xor</span>    eax,eax</span><br><span class="line">   <span class="number">0x00000000004015d8</span> &lt;+<span class="number">20</span>&gt;:    cmp    DWORD PTR [rip+<span class="number">0x202181</span>],<span class="number">0x6</span>        # <span class="number">0x603760</span> &lt;num_input_strings&gt;</span><br><span class="line">   <span class="number">0x00000000004015df</span> &lt;+<span class="number">27</span>&gt;:    jne    <span class="number">0x40163f</span> &lt;phase_defused+<span class="number">123</span>&gt;</span><br><span class="line">   <span class="number">0x00000000004015e1</span> &lt;+<span class="number">29</span>&gt;:    lea    r8,[rsp+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x00000000004015e6</span> &lt;+<span class="number">34</span>&gt;:    lea    rcx,[rsp+<span class="number">0xc</span>]</span><br><span class="line">   <span class="number">0x00000000004015eb</span> &lt;+<span class="number">39</span>&gt;:    lea    rdx,[rsp+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x00000000004015f0</span> &lt;+<span class="number">44</span>&gt;:    mov    esi,<span class="number">0x402619</span></span><br><span class="line">   <span class="number">0x00000000004015f5</span> &lt;+<span class="number">49</span>&gt;:    mov    edi,<span class="number">0x603870</span></span><br><span class="line">   <span class="number">0x00000000004015fa</span> &lt;+<span class="number">54</span>&gt;:    call   <span class="number">0x400bf0</span> &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">   <span class="number">0x00000000004015ff</span> &lt;+<span class="number">59</span>&gt;:    cmp    eax,<span class="number">0x3</span></span><br><span class="line">   <span class="number">0x0000000000401602</span> &lt;+<span class="number">62</span>&gt;:    jne    <span class="number">0x401635</span> &lt;phase_defused+<span class="number">113</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401604</span> &lt;+<span class="number">64</span>&gt;:    mov    esi,<span class="number">0x402622</span></span><br><span class="line">   <span class="number">0x0000000000401609</span> &lt;+<span class="number">69</span>&gt;:    lea    rdi,[rsp+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x000000000040160e</span> &lt;+<span class="number">74</span>&gt;:    call   <span class="number">0x401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">   <span class="number">0x0000000000401613</span> &lt;+<span class="number">79</span>&gt;:    test   eax,eax</span><br><span class="line">   <span class="number">0x0000000000401615</span> &lt;+<span class="number">81</span>&gt;:    jne    <span class="number">0x401635</span> &lt;phase_defused+<span class="number">113</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401617</span> &lt;+<span class="number">83</span>&gt;:    mov    edi,<span class="number">0x4024f8</span></span><br><span class="line">   <span class="number">0x000000000040161c</span> &lt;+<span class="number">88</span>&gt;:    call   <span class="number">0x400b10</span> &lt;puts@plt&gt;</span><br><span class="line">   <span class="number">0x0000000000401621</span> &lt;+<span class="number">93</span>&gt;:    mov    edi,<span class="number">0x402520</span></span><br><span class="line">   <span class="number">0x0000000000401626</span> &lt;+<span class="number">98</span>&gt;:    call   <span class="number">0x400b10</span> &lt;puts@plt&gt;</span><br><span class="line">   <span class="number">0x000000000040162b</span> &lt;+<span class="number">103</span>&gt;:   mov    eax,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x0000000000401630</span> &lt;+<span class="number">108</span>&gt;:   call   <span class="number">0x401242</span> &lt;secret_phase&gt;</span><br><span class="line">   <span class="number">0x0000000000401635</span> &lt;+<span class="number">113</span>&gt;:   mov    edi,<span class="number">0x402558</span></span><br><span class="line">   <span class="number">0x000000000040163a</span> &lt;+<span class="number">118</span>&gt;:   call   <span class="number">0x400b10</span> &lt;puts@plt&gt;</span><br><span class="line">   <span class="number">0x000000000040163f</span> &lt;+<span class="number">123</span>&gt;:   mov    rax,QWORD PTR [rsp+<span class="number">0x68</span>]</span><br><span class="line">   <span class="number">0x0000000000401644</span> &lt;+<span class="number">128</span>&gt;:   <span class="keyword">xor</span>    rax,QWORD PTR fs:<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x000000000040164d</span> &lt;+<span class="number">137</span>&gt;:   je     <span class="number">0x401654</span> &lt;phase_defused+<span class="number">144</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040164f</span> &lt;+<span class="number">139</span>&gt;:   call   <span class="number">0x400b30</span> &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   <span class="number">0x0000000000401654</span> &lt;+<span class="number">144</span>&gt;:   add    rsp,<span class="number">0x78</span></span><br><span class="line">   <span class="number">0x0000000000401658</span> &lt;+<span class="number">148</span>&gt;:   ret</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<aside>
💡 笔记：cmp    DWORD PTR [rip+0x202181],0x6  中 rip 使用的是下一条指令地址
</aside>
<p><img src="/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/Untitled%203.png" alt="Untitled"></p>
<h2 id="Part-s-2-secret-phase">Part s.2 secret_phase</h2>
<p>使用strtol()解析输入，输入第一部分的数字不能大于1000，且传到<code>fun7()</code>后返回值必须为2.</p>
<p>反编译：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">secret_phase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v0; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">read_line</span>();</span><br><span class="line">  v1 = <span class="built_in">strtol</span>(v0, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 - <span class="number">1</span> &gt; <span class="number">1000</span> )</span><br><span class="line">    ((<span class="built_in">void</span> (*)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, ...))explode_bomb)(v0, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">fun7</span>((__int64)&amp;n1, v1) != <span class="number">2</span> )</span><br><span class="line">    ((<span class="built_in">void</span> (*)(<span class="type">void</span> *, <span class="type">const</span> <span class="type">char</span> *, ...))explode_bomb)(&amp;n1, (<span class="type">const</span> <span class="type">char</span> *)v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Wow! You&#x27;ve defused the secret stage!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">phase_defused</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反汇编：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">dump of assembler code <span class="keyword">for</span> function secret_phase:</span><br><span class="line">   <span class="number">0x0000000000401242</span> &lt;+<span class="number">0</span>&gt;:     push   rbx</span><br><span class="line">   <span class="number">0x0000000000401243</span> &lt;+<span class="number">1</span>&gt;:     call   <span class="number">0x40149e</span> &lt;read_line&gt;</span><br><span class="line">   <span class="number">0x0000000000401248</span> &lt;+<span class="number">6</span>&gt;:     mov    edx,<span class="number">0xa</span></span><br><span class="line">   <span class="number">0x000000000040124d</span> &lt;+<span class="number">11</span>&gt;:    mov    esi,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x0000000000401252</span> &lt;+<span class="number">16</span>&gt;:    mov    rdi,rax</span><br><span class="line">   <span class="number">0x0000000000401255</span> &lt;+<span class="number">19</span>&gt;:    call   <span class="number">0x400bd0</span> &lt;strtol@plt&gt;</span><br><span class="line">   <span class="number">0x000000000040125a</span> &lt;+<span class="number">24</span>&gt;:    mov    rbx,rax</span><br><span class="line">   <span class="number">0x000000000040125d</span> &lt;+<span class="number">27</span>&gt;:    lea    eax,[rax<span class="number">-0x1</span>]</span><br><span class="line">   <span class="number">0x0000000000401260</span> &lt;+<span class="number">30</span>&gt;:    cmp    eax,<span class="number">0x3e8</span></span><br><span class="line">   <span class="number">0x0000000000401265</span> &lt;+<span class="number">35</span>&gt;:    jbe    <span class="number">0x40126c</span> &lt;secret_phase+<span class="number">42</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401267</span> &lt;+<span class="number">37</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x000000000040126c</span> &lt;+<span class="number">42</span>&gt;:    mov    esi,ebx</span><br><span class="line">   <span class="number">0x000000000040126e</span> &lt;+<span class="number">44</span>&gt;:    mov    edi,<span class="number">0x6030f0</span></span><br><span class="line">   <span class="number">0x0000000000401273</span> &lt;+<span class="number">49</span>&gt;:    call   <span class="number">0x401204</span> &lt;fun7&gt;</span><br><span class="line">   <span class="number">0x0000000000401278</span> &lt;+<span class="number">54</span>&gt;:    cmp    eax,<span class="number">0x2</span></span><br><span class="line">   <span class="number">0x000000000040127b</span> &lt;+<span class="number">57</span>&gt;:    je     <span class="number">0x401282</span> &lt;secret_phase+<span class="number">64</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040127d</span> &lt;+<span class="number">59</span>&gt;:    call   <span class="number">0x40143a</span> &lt;explode_bomb&gt;</span><br><span class="line">   <span class="number">0x0000000000401282</span> &lt;+<span class="number">64</span>&gt;:    mov    edi,<span class="number">0x402438</span></span><br><span class="line">   <span class="number">0x0000000000401287</span> &lt;+<span class="number">69</span>&gt;:    call   <span class="number">0x400b10</span> &lt;puts@plt&gt;</span><br><span class="line">   <span class="number">0x000000000040128c</span> &lt;+<span class="number">74</span>&gt;:    call   <span class="number">0x4015c4</span> &lt;phase_defused&gt;</span><br><span class="line">   <span class="number">0x0000000000401291</span> &lt;+<span class="number">79</span>&gt;:    pop    rbx</span><br><span class="line">   <span class="number">0x0000000000401292</span> &lt;+<span class="number">80</span>&gt;:    ret</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<h2 id="Part-s-3-func7">Part s.3 func7</h2>
<p>最后一步的难点是看出来这是在二叉树上进行运算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x401273</span> &lt;secret_phase+<span class="number">49</span>&gt;    call   fun7                      &lt;fun7&gt;</span><br><span class="line">        rdi: <span class="number">0x6030f0</span> (n1) ◂— <span class="number">0x24</span> <span class="comment">/* &#x27;$&#x27; */</span></span><br><span class="line">        rsi: <span class="number">0x29a</span></span><br><span class="line">        rdx: <span class="number">0x0</span></span><br><span class="line">        rcx: <span class="number">0x603963</span> (input_strings+<span class="number">483</span>) —▸ <span class="number">0x616b6a</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; disassemb fun7</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function fun7:</span><br><span class="line">   <span class="number">0x0000000000401204</span> &lt;+<span class="number">0</span>&gt;:     sub    rsp,<span class="number">0x8</span></span><br><span class="line">   <span class="number">0x0000000000401208</span> &lt;+<span class="number">4</span>&gt;:     test   rdi,rdi</span><br><span class="line">   <span class="number">0x000000000040120b</span> &lt;+<span class="number">7</span>&gt;:     je     <span class="number">0x401238</span> &lt;fun7+<span class="number">52</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040120d</span> &lt;+<span class="number">9</span>&gt;:     mov    edx,DWORD PTR [rdi]</span><br><span class="line">   <span class="number">0x000000000040120f</span> &lt;+<span class="number">11</span>&gt;:    cmp    edx,esi</span><br><span class="line">   <span class="number">0x0000000000401211</span> &lt;+<span class="number">13</span>&gt;:    jle    <span class="number">0x401220</span> &lt;fun7+<span class="number">28</span>&gt;</span><br><span class="line">   <span class="number">0x0000000000401213</span> &lt;+<span class="number">15</span>&gt;:    mov    rdi,QWORD PTR [rdi+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x0000000000401217</span> &lt;+<span class="number">19</span>&gt;:    call   <span class="number">0x401204</span> &lt;fun7&gt;</span><br><span class="line">   <span class="number">0x000000000040121c</span> &lt;+<span class="number">24</span>&gt;:    add    eax,eax</span><br><span class="line">   <span class="number">0x000000000040121e</span> &lt;+<span class="number">26</span>&gt;:    jmp    <span class="number">0x40123d</span> &lt;fun7+<span class="number">57</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x0000000000401220</span> &lt;+<span class="number">28</span>&gt;:    mov    eax,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x0000000000401225</span> &lt;+<span class="number">33</span>&gt;:    cmp    edx,esi</span><br><span class="line">   <span class="number">0x0000000000401227</span> &lt;+<span class="number">35</span>&gt;:    je     <span class="number">0x40123d</span> &lt;fun7+<span class="number">57</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x0000000000401229</span> &lt;+<span class="number">37</span>&gt;:    mov    rdi,QWORD PTR [rdi+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x000000000040122d</span> &lt;+<span class="number">41</span>&gt;:    call   <span class="number">0x401204</span> &lt;fun7&gt;</span><br><span class="line">   <span class="number">0x0000000000401232</span> &lt;+<span class="number">46</span>&gt;:    lea    eax,[rax+rax*<span class="number">1</span>+<span class="number">0x1</span>]</span><br><span class="line">   <span class="number">0x0000000000401236</span> &lt;+<span class="number">50</span>&gt;:    jmp    <span class="number">0x40123d</span> &lt;fun7+<span class="number">57</span>&gt;</span><br><span class="line">---------------------------- 如果rdi == <span class="number">0</span> 就返回<span class="number">0xffffffff</span></span><br><span class="line">   <span class="number">0x0000000000401238</span> &lt;+<span class="number">52</span>&gt;:    mov    eax,<span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">   <span class="number">0x000000000040123d</span> &lt;+<span class="number">57</span>&gt;:    add    rsp,<span class="number">0x8</span></span><br><span class="line">   <span class="number">0x0000000000401241</span> &lt;+<span class="number">61</span>&gt;:    ret</span><br><span class="line">End of assembler dump</span><br></pre></td></tr></table></figure>
<p>secret中将0x6030f0传给rdi，rdi为函数的第一个参数，可以查看下0x6030f0的内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">80</span>gx <span class="number">0x6030f0</span></span><br><span class="line"><span class="number">0x6030f0</span> &lt;n1&gt;:  <span class="number">0x0000000000000024</span>      <span class="number">0x0000000000603110</span></span><br><span class="line"><span class="number">0x603100</span> &lt;n1+<span class="number">16</span>&gt;:       <span class="number">0x0000000000603130</span>      <span class="number">0x00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0x603110</span> &lt;n21&gt;: <span class="number">0x0000000000000008</span>      <span class="number">0x0000000000603190</span></span><br><span class="line"><span class="number">0x603120</span> &lt;n21+<span class="number">16</span>&gt;:      <span class="number">0x0000000000603150</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603130</span> &lt;n22&gt;: <span class="number">0x0000000000000032</span>      <span class="number">0x0000000000603170</span></span><br><span class="line"><span class="number">0x603140</span> &lt;n22+<span class="number">16</span>&gt;:      <span class="number">0x00000000006031b0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603150</span> &lt;n32&gt;: <span class="number">0x0000000000000016</span>      <span class="number">0x0000000000603270</span></span><br><span class="line"><span class="number">0x603160</span> &lt;n32+<span class="number">16</span>&gt;:      <span class="number">0x0000000000603230</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603170</span> &lt;n33&gt;: <span class="number">0x000000000000002d</span>      <span class="number">0x00000000006031d0</span></span><br><span class="line"><span class="number">0x603180</span> &lt;n33+<span class="number">16</span>&gt;:      <span class="number">0x0000000000603290</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603190</span> &lt;n31&gt;: <span class="number">0x0000000000000006</span>      <span class="number">0x00000000006031f0</span></span><br><span class="line"><span class="number">0x6031a0</span> &lt;n31+<span class="number">16</span>&gt;:      <span class="number">0x0000000000603250</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6031b0</span> &lt;n34&gt;: <span class="number">0x000000000000006b</span>      <span class="number">0x0000000000603210</span></span><br><span class="line"><span class="number">0x6031c0</span> &lt;n34+<span class="number">16</span>&gt;:      <span class="number">0x00000000006032b0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6031d0</span> &lt;n45&gt;: <span class="number">0x0000000000000028</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6031e0</span> &lt;n45+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6031f0</span> &lt;n41&gt;: <span class="number">0x0000000000000001</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603200</span> &lt;n41+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603210</span> &lt;n47&gt;: <span class="number">0x0000000000000063</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603220</span> &lt;n47+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603230</span> &lt;n44&gt;: <span class="number">0x0000000000000023</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603240</span> &lt;n44+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603250</span> &lt;n42&gt;: <span class="number">0x0000000000000007</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603260</span> &lt;n42+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603270</span> &lt;n43&gt;: <span class="number">0x0000000000000014</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603280</span> &lt;n43+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603290</span> &lt;n46&gt;: <span class="number">0x000000000000002f</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6032a0</span> &lt;n46+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6032b0</span> &lt;n48&gt;: <span class="number">0x00000000000003e9</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6032c0</span> &lt;n48+<span class="number">16</span>&gt;:      <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6032d0</span> &lt;node1&gt;:       <span class="number">0x000000010000014c</span>      <span class="number">0x00000000006032e0</span></span><br><span class="line"><span class="number">0x6032e0</span> &lt;node2&gt;:       <span class="number">0x00000002000000a8</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6032f0</span> &lt;node3&gt;:       <span class="number">0x000000030000039c</span>      <span class="number">0x0000000000603300</span></span><br><span class="line"><span class="number">0x603300</span> &lt;node4&gt;:       <span class="number">0x00000004000002b3</span>      <span class="number">0x0000000000603310</span></span><br><span class="line"><span class="number">0x603310</span> &lt;node5&gt;:       <span class="number">0x00000005000001dd</span>      <span class="number">0x0000000000603320</span></span><br><span class="line"><span class="number">0x603320</span> &lt;node6&gt;:       <span class="number">0x00000006000001bb</span>      <span class="number">0x0000000000</span></span><br></pre></td></tr></table></figure>
<p>可以猜测这里存放着二叉树，结构可能为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">node</span>&#123;</span><br><span class="line">    <span class="type">long</span> val;           </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node</span> *l,*r; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 每个node后补了8个字节，可能是为了内存对齐</span></span><br></pre></td></tr></table></figure>
<p>可以根据这些n画出完整的二叉树，但人工画有点麻烦，不如先思考怎样得到所需的返回值2。</p>
<p>IDA反编译代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">fun7</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)a1 &gt; (<span class="type">int</span>)a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">fun7</span>(*(_QWORD *)(a1 + <span class="number">8</span>), a2);</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)a1 != (_DWORD)a2 )</span><br><span class="line">    result = <span class="number">2</span> * (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">fun7</span>(*(_QWORD *)(a1 + <span class="number">16</span>), a2) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>a1(rdi)其实是二叉树的根，a1+8对应左子树，a1+16对应右子树。</p>
<p>若访问到空节点，则返回值会出现<code>0xffffffff</code>，所以我们只能在树上（软件原因树的最右分枝未补全）的节点选择。通过代码我们知道，若从节点<code>x</code>出发<code>result</code>初始值为<code>0</code>，若改节点为右儿子则<code>a=2*a+1</code>、为左儿子则<code>a=a*2</code>。</p>
<p>由于2 = 2 * 1，所以需要的节点x满足，x是其父节点y的右儿子，y是根节点a1（rsi）的左儿子。</p>
<p><img src="/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/Untitled%204.png" alt="Untitled"></p>
<p>所以输入20（或者0x603150的左儿子）就行。</p>
<h1 id="笔记">笔记</h1>
<ul>
<li>不小心按ctrl-z把进程suspend了，可以使用<code>jobs</code>查询当前工作，然后<code>fg N (bash)</code> 或 <code>fg %N(zsh)</code> 将任务从后台转入前台</li>
</ul>
<h1 id="参考资料">参考资料</h1>
<ul>
<li>Introduction to CSAPP（十九）：这可能是你能找到的分析最全的Bomblab了 - Yannick的文章 - 知乎<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/104130161">https://zhuanlan.zhihu.com/p/104130161</a></li>
<li>《深入理解计算机系统/CSAPP》Bomb Lab - 上岸改名了的文章 - 知乎<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/57977157">https://zhuanlan.zhihu.com/p/57977157</a></li>
<li><a target="_blank" rel="noopener" href="https://earthaa.github.io/2020/01/12/CSAPP-Bomblab/">https://earthaa.github.io/2020/01/12/CSAPP-Bomblab/</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://jkup64.github.io">徒心</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://jkup64.github.io/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/">https://jkup64.github.io/2023/05/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l2-bomblab/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jkup64.github.io" target="_blank">徒心的网络自留地</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CSAPP/">CSAPP</a></div><div class="post_share"><div class="social-share" data-image="/images/csapp.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/24/C-%E3%80%8AC-Primer-5th%E3%80%8B-ch05/" title="第5章 语句"><img class="cover" src="/images/cpp.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第5章 语句</div></div></a></div><div class="next-post pull-right"><a href="/2023/06/01/C-%E3%80%8AC-Primer-5th%E3%80%8B-ch06/" title="第6章 函数"><img class="cover" src="/images/cpp.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第6章 函数</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l1-datalab/" title="CSAPP-Datalab详解"><img class="cover" src="/images/csapp.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-21</div><div class="title">CSAPP-Datalab详解</div></div></a></div><div><a href="/2023/06/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l3-attacklab/" title="CSAPP-Attacklab详解"><img class="cover" src="/images/csapp.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-21</div><div class="title">CSAPP-Attacklab详解</div></div></a></div><div><a href="/2023/09/02/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-CSAPP-l4-cachelab/" title="CSAPP-Cachelab详解"><img class="cover" src="/images/csapp.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-02</div><div class="title">CSAPP-Cachelab详解</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#phase-1"><span class="toc-number">1.</span> <span class="toc-text">phase_1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phase-2"><span class="toc-number">2.</span> <span class="toc-text">phase_2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phase-3"><span class="toc-number">3.</span> <span class="toc-text">phase_3</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phase-4"><span class="toc-number">4.</span> <span class="toc-text">phase_4</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phase-5"><span class="toc-number">5.</span> <span class="toc-text">phase_5</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phase-6"><span class="toc-number">6.</span> <span class="toc-text">phase_6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-6-1-%E9%A2%84%E6%A3%80%E6%B5%8B"><span class="toc-number">6.1.</span> <span class="toc-text">Part 6.1 预检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-6-2-%E4%B8%83%E5%87%8F%E5%A4%84%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">Part 6.2 七减处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-6-3-%E6%A0%B9%E6%8D%AE%E8%BE%93%E5%85%A5narr-i-%E5%B0%86node-narr-i-%E7%9A%84%E5%9C%B0%E5%9D%80%E5%A4%8D%E5%88%B6%E5%88%B0stack-nnode-i"><span class="toc-number">6.3.</span> <span class="toc-text">Part 6.3 根据输入narr[i]将node[narr[i]]的地址复制到stack[nnode[i]]</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-6-4"><span class="toc-number">6.4.</span> <span class="toc-text">Part 6.4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-6-5-%E9%81%8D%E5%8E%86%E6%A3%80%E6%9F%A5%E9%93%BE%E8%A1%A8%E4%B8%AD%E5%80%BC%E5%A4%A7%E5%B0%8F"><span class="toc-number">6.5.</span> <span class="toc-text">Part 6.5 遍历检查链表中值大小</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#secret-phase"><span class="toc-number">7.</span> <span class="toc-text">secret_phase</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-s-1-phase-defused"><span class="toc-number">7.1.</span> <span class="toc-text">Part s.1 phase_defused</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-s-2-secret-phase"><span class="toc-number">7.2.</span> <span class="toc-text">Part s.2 secret_phase</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-s-3-func7"><span class="toc-number">7.3.</span> <span class="toc-text">Part s.3 func7</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%94%E8%AE%B0"><span class="toc-number">8.</span> <span class="toc-text">笔记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 徒心</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline-server-jkup64.vercel.app',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js')
      initWaline()
    }
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>